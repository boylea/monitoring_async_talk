<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Monitoring Async Apps</title><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><meta name="author" content="Amy Boyle"></meta><meta name="description" content="Why and how to measure asynchronous applications"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="async.css" media="screen,projection"></link></head><body class="impress-not-supported"><div id="impress" data-transition-duration="1"><div class="step step-level-1" step="0" id="title" data-scale="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-x="0" data-y="0" data-z="0"><h1 id="monitoring-asynchronous-applications">Monitoring Asynchronous Applications</h1><h2 id="amy-boyle-amylouboyle">Amy Boyle <a href="https://twitter.com/amylouboyle">@amylouboyle</a></h2><div class="notes"><p>background from subtlepatterns.com</p><p>Async == Asynchronous</p></div></div><div class="step step-level-1" step="1" data-x="500" data-y="1200" data-z="-500" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1"><h1 id="monitoring-async-applications">Monitoring Async Applications</h1><h2 id="id2">Amy Boyle <a href="https://twitter.com/amylouboyle">@amylouboyle</a></h2></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1000" data-y="2400" data-z="-1000"><p>Roadmap</p><ul><li>Who am I and why?</li><li>What and why async?</li><li>Monitoring</li><li>How to measure async</li><li>General solution</li></ul></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1500" data-y="3600" data-z="-1500"><img src="img/whoami_transition.png"></img><div class="notes"><p>German Shepherd puppy: <a href="https://www.flickr.com/photos/jn2race/263170635">https://www.flickr.com/photos/jn2race/263170635</a></p></div></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="2000" data-y="4800" data-z="-2000"><p><strong>Software Engineer @</strong></p><img src="img/NewRelic-logo-square.png" width="200px" height="200px"></img><div class="notes"><p>I am a software engineer at New Relic. New Relic provides multiple monitoring products, most notably APM.</p><p>Recently I was working on gathering Async performance metrics for Python. This turned out to be a non-trivial task, so I thought I'd write a talk to share with y'all some of the things I learned.</p></div></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="2500" data-y="6000" data-z="-2500"><img src="img/async_transition.png"></img><div class="notes"><p>There is some confusion on the internet as to what the terms surrounding concurrency mean. So I'm going to define them for you, and provide an explanation to serve as a framework for understanding the rest of this talk.</p></div></div><div class="step step-level-1" step="6" id="paradigm-overview" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3000" data-y="7200" data-z="-3000"><ul><li>Synchronous</li></ul><img src="img/sync_diagram.png"></img><ul><li><dl><dt>Concurrent</dt><dd><ul><li>Parallel<blockquote><img src="img/parallel_diagram.png"></img></blockquote></li><li>Asynchronous<blockquote><img src="img/async_diagram.png"></img></blockquote></li></ul></dd></dl></li></ul><div class="notes"><p>Synchronous paradigm is the traditional way of doing things. Only executing on one task at a time, one after the other.</p><p>A concurrent program is one that is able to work on multiple tasks in the same period of time.</p><p>Parallel execution mean running different tasks in the same instant of time. For this we must have multiple CPU cores.</p><p>Asynchronous is interleaved task execution. We can alternately run chunks of different tasks.</p></div></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3500" data-y="8400" data-z="-3500"><img src="img/spilled_food_adjusted.jpg" width="500px" height="500px"></img><img src="img/meli_pup_cuddle_adjusted.jpg" width="500px" height="500px"></img><div class="notes"><p>A talk about async wouldn't be complete without an analogy</p><p>Let's say you have you have a litter of puppies. Each puppy needs to be fed and cuddled.</p><p><a href="https://flic.kr/p/NCCT1">https://flic.kr/p/NCCT1</a> spilled food</p><p>Meli Lewis said I could use her photo</p></div></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4000" data-y="9600" data-z="-4000"><h1 id="synchronous">Synchronous</h1><img src="img/sync_puppy_diagram.png"></img><div class="notes"><p>Explain diagram.</p><p>If you were to do this in a totally synchronous fashion, you would give a puppy its food, stand there and wait for her to finish, then clean up. Then you'd do that for the next puppy and the next etc.
Then you would pick up and cuddle each puppy in turn as well.</p></div></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4500" data-y="10800" data-z="-4500"><h1 id="parallel">Parallel</h1><img src="img/parallel_puppy_diagram.png"></img><div class="notes"><p>Parallel is if you had friends that could feed and cuddle the puppies, one each, all at the same time.</p></div></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="5000" data-y="12000" data-z="-5000"><h1 id="asynchronous">Asynchronous</h1><img src="img/async_puppy_diagram.png"></img><div class="notes"><p>Asynchronous fashion would allow you to give a puppy her food, and while she is eating you can move on to another puppy and give her her food. Since cuddling is an active task you can can't do anything else while you cuddle a puppy.</p></div></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="5500" data-y="13200" data-z="-5500"><p>Human = CPU</p><p>Puppy = Task</p><p>Feeding = I/O call</p><p>Cuddling = CPU intensive code</p></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6000" data-y="14400" data-z="-6000"><p>Examples will be in <span class="strike">Pseudocode</span> Python</p><img src="img/tornado.png"></img><div class="notes"><p>Mostly because Python is my favorite language, but also because pseudocode looks like Python. My hope is that even if you don't know python that you'll be able to follow the examples. I'll also be using the Tornado web framework because it has an elegant API that allows for concise examples, where we'll be able to stay at a high level.</p><p>I am taking an example-based approach.</p><p>If you are familiar with advanced python, you may notice that I have sacrificed best practices/safety for the sake of simplicity. Do not copy and use this code as is.</p><p>There are also some places where I'm going to gloss over the details. My goal here is to outline the fundamental concepts, not show python tricks.</p></div></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6500" data-y="15600" data-z="-6500"><p>Asynchronous code <em>yields</em> execution to other pieces of code</p><img src="img/sync_vs_async_unmarked.png" width="800"></img><div class="notes"><p>This is a coroutine</p></div></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="7000" data-y="16800" data-z="-7000"><p>Asynchronous code <em>yields</em> execution to other pieces of code</p><img src="img/sync_vs_async_sync_marked.png" width="800"></img></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="7500" data-y="18000" data-z="-7500"><p>Asynchronous code <em>yields</em> execution to other pieces of code</p><img src="img/sync_vs_async_async_await.png" width="800"></img></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="19200" data-z="-8000"><p>Asynchronous code <em>yields</em> execution to other pieces of code</p><img src="img/sync_vs_async_async_marked.png" width="800"></img></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8500" data-y="20400" data-z="-8500"><pre class="highlight code python"><span class="k">class</span> <span class="nc">EventLoop</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">this_round</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">this_round</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span></pre><div class="notes"><p>This is single threaded so we don't need locks</p></div></div><div class="step step-level-1" step="18" id="ex-fetch2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9000" data-y="21600" data-z="-9000"><p>Asynchronous code <em>yields</em> execution to other pieces of code</p><img src="img/sync_vs_async_multi.png" width="1024"></img><div class="notes"><p>What this code demonstrates is the ability to wait on multiple IO calls for the same task at a time.</p><p>For each handler we have 10 IO calls to make (in this case 10 http fetches), in the synchronous case we have to wait for each fetch to return before we get the next one, and this is a blocking wait, nothing else is able to run while the IO is taking place.</p><p>In the Async handler we can fire off each fetch, and then wait for them all to complete at the same time. While we are waiting we can also execute any other code that needs to run.</p></div></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9500" data-y="22800" data-z="-9500"><h1 id="winning">Winning!</h1><ul><li>Wait on all I/O at the same time</li><li>Other code can use the CPU while I/O is executing</li><li>Do work after response is sent back</li><li>No thread messiness</li></ul><div class="notes"><p>This supports multiple long-lived connections to a user</p><p>Most common manifestation is event loops</p></div></div><div class="step step-level-1" step="20" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="10000" data-y="24000" data-z="-10000"><img src="img/monitor_transition.png"></img><div class="notes"><p>Now that we know what an async app is, and why we should use it, I'm going to talk just a bit about monitoring it.</p><p>First of all, what do I mean when I say monitoring?</p></div></div><div class="step step-level-1" step="21" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="10500" data-y="25200" data-z="-10500"><h1 id="collecting-data-on-your-app-in-production">Collecting data on your app in production</h1><div class="notes"><p>Monitoring is Collecting and processing data about your application as it is running</p></div></div><div class="step step-level-1" step="22" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11000" data-y="26400" data-z="-11000"><h1 id="not-profiling">Not Profiling</h1><div class="notes"><ul><li>high overhead</li><li>critically, for async, doesn't give context</li></ul><p>What data are we going to collect?</p></div></div><div class="step step-level-1" step="23" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11500" data-y="27600" data-z="-11500"><ul><li>Execution times for: handlers, queries, layers of stack</li><li>Throughput</li><li>Error rate</li></ul><div class="notes"><p>Some of most common types of data we would want to monitor are Timing data, throughput and error rate. Since it's not specific to async, we're not going to look at throughput or error rate for this talk.</p><p>Monitoring is a VERY large topic, not covering most of it here</p><p>I'm going to focus on what is specific to asynchronous apps</p></div></div><div class="step step-level-1" step="24" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12000" data-y="28800" data-z="-12000"><p>Your users should not be your monitoring system</p><div class="notes"><p>Why should you have monitoring in the first place? I'm hoping if you're at this talk, I don't need to sell you on the importance of monitoring in general.</p><p>If your app is a source of income (or pride), and it's broken, you're losing money/sleep. So we'd prefer to find problems sooner, ideally before they become a real problem for our users.</p><p>By broken I mean not just total unavailable, or throwing errors.</p><p>Performance matters. Slow websites erode the sanity of your users.</p></div></div><div class="step step-level-1" step="25" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12500" data-y="30000" data-z="-12500"><p>Visualize your data in a way that is consumable</p><img src="img/server_log_file.png" width="500px" height="500px"></img><div class="notes"><p>Tailing a log file is not monitoring</p></div></div><div class="step step-level-1" step="26" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="13000" data-y="31200" data-z="-13000"><p>Visualize your data in a way that is consumable</p><img src="img/chart.png" width="500px" height="500px"></img><div class="notes"><p>Why is my website slow? hint: it's the database</p></div></div><div class="step step-level-1" step="27" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="13500" data-y="32400" data-z="-13500"><img src="img/measure_transition.png"></img></div><div class="step step-level-1" step="28" id="example-app" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14000" data-y="33600" data-z="-14000"><p>Our example app</p><pre class="highlight code python"><span class="k">def</span> <span class="nf">cuddle</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
    <span class="c1"># pretend to do processing</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ASyncRequestHandler</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">feed_puppy</span><span class="p">()</span>
        <span class="n">await</span> <span class="n">future</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="s1">'Pup is full!</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">cuddle</span><span class="p">()</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">([(</span><span class="s1">'/'</span><span class="p">,</span> <span class="n">ASyncRequestHandler</span><span class="p">))]</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></pre></div><div class="step step-level-1" step="29" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14500" data-y="34800" data-z="-14500"><p>What to Measure</p><ul><li>Response time</li><li>Duration</li><li>CPU time</li><li>External time</li></ul><div class="notes"><p>We may not always want to, or be able to measure all of these.</p></div></div><div class="step step-level-1" step="30" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="15000" data-y="36000" data-z="-15000"><img src="img/response_time_diagram.png"></img></div><div class="step step-level-1" step="31" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="15500" data-y="37200" data-z="-15500"><p>Response Time</p><img src="img/response_time_code.png" width="1024"></img></div><div class="step step-level-1" step="32" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="38400" data-z="-16000"><img src="img/duration_diagram.png"></img></div><div class="step step-level-1" step="33" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16500" data-y="39600" data-z="-16500"><p>Duration</p><img src="img/duration_code.png" width="1024"></img></div><div class="step step-level-1" step="34" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17000" data-y="40800" data-z="-17000"><img src="img/cputime_diagram.png"></img></div><div class="step step-level-1" step="35" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17500" data-y="42000" data-z="-17500"><p>CPU time</p><img src="img/cpu_time_code.png" width="1024"></img></div><div class="step step-level-1" step="36" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="18000" data-y="43200" data-z="-18000"><img src="img/external_time_diagram.png"></img></div><div class="step step-level-1" step="37" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="18500" data-y="44400" data-z="-18500"><p>External Time</p><img src="img/external_time_code.png" width="1024"></img></div><div class="step step-level-1" step="38" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19000" data-y="45600" data-z="-19000"><img src="img/blocking_time_diagram.png"></img></div><div class="step step-level-1" step="39" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19500" data-y="46800" data-z="-19500"><p>Aggregate and collect data in monitor service</p><div class="notes"><p>I've created a simple plotting service which I can post data to, and it will use bokeh to chart the data.</p><p>This part is not async specific</p><p>I do get to use an async http client library to send data to my monitoring service, which keeps overhead low.</p></div></div><div class="step step-level-1" step="40" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20000" data-y="48000" data-z="-20000"><p>Percentiles are better than the mean</p><pre class="highlight code python"><span class="n">times</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="n">index95</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">*</span><span class="mf">0.95</span><span class="p">)</span>
<span class="n">data_point</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">index95</span><span class="p">]</span></pre><div class="notes"><p>If your webservice has a mean latency of 100ms, your top 1% of requests may take 5 seconds. This is a bad user experience on it's own if that is a stand-alone service. However, with today's tend to move towards microservice architecture, if several such services are needed to render a page, the 99th percentile of one backend may become the median response of what the user experiences.</p></div></div><div class="step step-level-1" step="41" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20500" data-y="49200" data-z="-20500"><p>To the demo!</p></div><div class="step step-level-1" step="42" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="21000" data-y="50400" data-z="-21000"><p>CPU intensive tasks are bad news for async architecture</p><img src="img/blocking_diagram.png"></img></div><div class="step step-level-1" step="43" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="21500" data-y="51600" data-z="-21500"><img src="img/general_solution_transition.png"></img><div class="notes"><p>Now that we're seen an example of what gathering this data looks like, I want to talk more generally about how to collect async data. How we can widely apply gathering async metrics from our app.</p></div></div><div class="step step-level-1" step="44" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22000" data-y="52800" data-z="-22000"><p><strong>Strategies for a general solution</strong></p><ul><li>Black box</li><li>Bake it in</li><li>Monkey patch code base</li></ul><div class="notes"><p>Of course, if for reduced effort, but also reduced insight to our app, we can monitor just response time using an outside service, that is watching request and responses.</p><p>Like I showed in the example, we can embed stopwatches into our code directly.</p><p>If we have a lot of async code, and this becomes tiresome, or we want do decouple our monitoring from our service, we can put the monitioring code in it's own modules or functions, and patch that into our app.</p></div></div><div class="step step-level-1" step="45" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22500" data-y="54000" data-z="-22500"><p>Challenge of a general solution:</p><p><strong>Keeping track of callbacks</strong></p><pre class="highlight code python"><span class="k">class</span> <span class="nc">ASyncRequestHandler2</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">feed_puppy2</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="n">cuddle_pup</span><span class="p">)</span></pre><div class="notes"><p>The example I used before used Python coroutines, which allows us to yield execution in the middle of a function. This kept all our timer data neatly in one place.</p><p>This may not always be the case. In other languages, or using 3rd party libraries, and async function may take a callback that it will execute when it finishes.</p></div></div><div class="step step-level-1" step="46" id="wrap-cuddle" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="23000" data-y="55200" data-z="-23000"><pre class="highlight code python"><span class="k">class</span> <span class="nc">ASyncRequestHandler2</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">feed_puppy</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cuddle_pup_wrap</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cuddle_pup_wrap</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">cuddle_pup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cuddle_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span></pre><div class="notes"><p>In order to include execution time data for this function, we can wrap in our own function that simply calls the original function surrounded by a stopwatch.</p></div></div><div class="step step-level-1" step="47" id="wrap-cuddle2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="23500" data-y="56400" data-z="-23500"><p><strong>Multiple callbacks?</strong></p><pre class="highlight code python"><span class="k">class</span> <span class="nc">ASyncRequestHandler2</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cuddle_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">feed_puppy</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cuddle_pup_wrap</span><span class="p">)</span>
        <span class="n">feed_puppy</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cuddle_pup_wrap</span><span class="p">)</span>
        <span class="n">feed_puppy</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cuddle_pup_wrap</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cuddle_pup_wrap</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">cuddle_pup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cuddle_time</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span></pre><div class="notes"><p>However, if we have several async calls, which one will be done first? How do we know when to stop collecting, and process our data? In this case our "general solution" becomes necessary to get any data at all</p></div></div><div class="step step-level-1" step="48" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="57600" data-z="-24000"><h1 id="keeping-track-of-the-pieces">Keeping Track of the pieces</h1><ol><li>Create an object to hold metrics</li><li>Pass it around via wrapper code</li><li>Have condition for when done</li></ol></div><div class="step step-level-1" step="49" id="link-callbacks" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24500" data-y="58800" data-z="-24500"><pre class="highlight code python"><span class="k">class</span> <span class="nc">Metrics</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="mi">0</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">args</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">done</span><span class="p">():</span>
        <span class="c1"># process and send data...</span>

<span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">ref_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="nf">timed</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">ref_count</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">process_if_done</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">timed</span>

<span class="k">class</span> <span class="nc">ASyncRequestHandler2</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">(</span><span class="s1">'cpu'</span><span class="p">)</span>
        <span class="n">feed_puppy</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="n">wrap</span><span class="p">(</span><span class="n">cuddle_pup</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="s1">'cpu'</span><span class="p">))</span>
        <span class="n">feed_puppy</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="n">wrap</span><span class="p">(</span><span class="n">cuddle_pup</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="s1">'cpu'</span><span class="p">))</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">'cpu'</span><span class="p">]</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span></pre><div class="notes"><p>Disclaimer: If you are familiar with advanced python, you may notice that I have sacrificed best practices/safety for simplicity here. Do not copy and use this code as is.</p></div></div><div class="step step-level-1" step="50" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25000" data-y="60000" data-z="-25000"><h1 id="critical-path">Critical Path</h1><pre class="highlight code python"><span class="k">class</span> <span class="nc">ASyncRequestHandler2</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>

    <span class="nd">@tornado.web.asynchronous</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">things_done</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">feed_puppy</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thing_done</span><span class="p">)</span>
        <span class="n">do_dishes</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thing_done</span><span class="p">)</span>
        <span class="n">roomba_room</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thing_done</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">thing_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">things_done</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">things_done</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">fight_crime</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="s1">'All chores done'</span><span class="p">)</span></pre><div class="notes"><p>looking back at this example where we had multiple external calls. We saw before how to keep track of the cpu time - which we know is important for throughput.</p><p>I'm going to depart from our puppy analogy a bit and introduce some other IO calls.</p><p>Thinking about this task by itself, what if one of the 3 chore we are doing in this task is a <em>really</em> slow eater? We want to know which particular call(s) is the limiting factor for us to finish. This is called the critical path.</p></div></div><div class="step step-level-1" step="51" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25500" data-y="61200" data-z="-25500"><img src="img/critical_path.png"></img></div><div class="step step-level-1" step="52" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="26000" data-y="62400" data-z="-26000"><img src="img/critical_path_highlight.png"></img></div><div class="step step-level-1" step="53" id="critical-path" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="26500" data-y="63600" data-z="-26500"><h1 id="id4">Critical Path</h1><pre class="highlight code python"><span class="k">class</span> <span class="nc">ASyncRequestHandler2</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>

    <span class="nd">@tornado.web.asynchronous</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">things_done</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">(</span><span class="s1">'io1'</span><span class="p">,</span><span class="s1">'io2'</span><span class="p">,</span><span class="s1">'io3'</span><span class="p">)</span>
        <span class="n">feed_puppy</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thing_done</span><span class="p">,</span> <span class="s1">'io1'</span><span class="p">)</span>
        <span class="n">do_dishes</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thing_done</span><span class="p">,</span> <span class="s1">'io2'</span><span class="p">)</span>
        <span class="n">roomba_room</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thing_done</span><span class="p">,</span> <span class="s1">'io3'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_done</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">thing_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">things_done</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_done</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">things_done</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">fight_crime</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="s1">'All chores done'</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">process</span><span class="p">()</span></pre></div><div class="step step-level-1" step="54" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27000" data-y="64800" data-z="-27000"><h1 id="use-tools-to-help-you">Use tools to help you</h1><ul><li>Statsd</li><li>Grafana</li><li>More ...</li></ul><div class="notes"><p>This is starting to get really complex. There are many open source and commercial tools out there to help you do this, or just do it for you.</p><p>You will probably not be trying to get all the data that I have outlined here. I have outline the building blocks of what kinds of metrics you want to look out for.</p></div></div><div class="step step-level-1" step="55" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27500" data-y="66000" data-z="-27500"><h1 id="how-to-monitor-async">How To Monitor Async</h1><ul><li>Figure out what to measure: Response, Duration, CPU, Blocking</li><li>Link the pieces together</li><li>Visualize the datas</li></ul></div><div class="step step-level-1" step="56" id="fin" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="28000" data-y="67200" data-z="-28000"><p>Slides/Source on Github: <a href="https://github.com/boylea/monitoring_async_talk">github.com/boylea/monitoring_async_talk</a></p><p><a href="https://twitter.com/amylouboyle">@amylouboyle</a></p></div></div><div id="hovercraft-help"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>